<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Medical Jobs Digest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    @import url("https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap");

    :root {
      --bg: #f7f4ef;
      --ink: #1c1b19;
      --muted: #6d6760;
      --card: #ffffff;
      --line: #e2ddd6;
      --accent: #1f5f4a;
      --accent-soft: #dceae4;
      --shadow: 0 16px 40px rgba(28, 27, 25, 0.08);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "IBM Plex Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, #f0ebe1 0%, transparent 60%),
        radial-gradient(800px 600px at 90% 10%, #e9f3ee 0%, transparent 55%),
        var(--bg);
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 28px 20px 80px;
    }

    header {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      align-items: center;
      margin-top: 10px;
    }

    .hero {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 20px;
      padding: 26px;
      box-shadow: var(--shadow);
    }

    .hero h1 {
      font-family: "IBM Plex Sans", sans-serif;
      font-size: clamp(2rem, 3vw, 2.8rem);
      font-weight: 700;
      margin: 0 0 8px;
      letter-spacing: -0.5px;
    }

    .hero p {
      margin: 0;
      color: var(--muted);
      font-size: 1rem;
      line-height: 1.5;
    }

    .stat {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 18px 20px;
      border: 1px solid var(--line);
      border-radius: 16px;
      background: var(--accent-soft);
    }

    .stat strong {
      font-size: 1.4rem;
      font-weight: 600;
    }

    .stat span {
      color: var(--muted);
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 18px;
    }

    .filter-btn {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.88rem;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .filter-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .filter-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    .filter-mobile { display: none; width: 100%; }
    .filter-location { display: block; width: 100%; }
    .filter-desktop { display: flex; flex-wrap: wrap; gap: 10px; width: 100%; }

    .filter-label {
      display: block;
      font-size: 0.88rem;
      color: var(--muted);
      margin: 0 0 6px;
    }

    .select-wrap {
      position: relative;
      width: 100%;
      max-width: 420px;
    }

    .select-wrap select {
      width: 100%;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 10px 44px 10px 14px;
      font-size: 0.95rem;
      background: var(--card);
      color: var(--ink);
    }

    .select-wrap::after {
      content: "‚ñæ";
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      opacity: 0.65;
      font-size: 18px;
    }

    @media (max-width: 640px) {
      .filter-mobile { display: block; }
      .filter-desktop { display: none; }
    }

    .grid {
      display: grid;
      gap: 18px;
      margin-top: 28px;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    }

    /* ===== SIMPLIFIED CARD STYLES ===== */
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 4px 12px rgba(28, 27, 25, 0.04);
      display: flex;
      flex-direction: column;
      gap: 10px;
      transition: box-shadow 0.2s, transform 0.2s;
    }

    .card.clickable {
      cursor: pointer;
    }

    .card.clickable:hover {
      box-shadow: 0 8px 24px rgba(28, 27, 25, 0.1);
      transform: translateY(-2px);
    }

    .card .title {
      font-family: "IBM Plex Sans", sans-serif;
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0;
      line-height: 1.35;
      color: var(--ink);
    }

    .card .meta {
      color: var(--muted);
      font-size: 0.9rem;
      margin: 0;
    }

    .card .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .card .tag {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.78rem;
      font-weight: 500;
    }

    .card .tag.job-type {
      background: #e8e4f0;
      color: #5b21b6;
    }

    .card .tag.deadline {
      background: #fef3e2;
      color: #b45309;
    }

    .card .salary {
      font-weight: 500;
      color: var(--accent);
      font-size: 0.92rem;
    }

    /* Action buttons row */
    .card-actions {
      display: flex;
      gap: 10px;
      margin-top: 4px;
    }

    .view-btn {
      flex: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--accent-soft);
      color: var(--accent);
      border: 1px solid transparent;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 0.88rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
    }

    .view-btn:hover {
      background: #c8e0d5;
      border-color: var(--accent);
    }

    .apply-btn {
      flex: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 0.88rem;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      transition: background 0.2s;
    }

    .apply-btn:hover {
      background: #174a39;
    }

    .apply-btn.disabled {
      background: var(--line);
      color: var(--muted);
      cursor: not-allowed;
    }

    @media (max-width: 480px) {
      .card-actions {
        flex-direction: column;
        gap: 8px;
      }

      .view-btn,
      .apply-btn {
        width: 100%;
      }
    }

    /* Scope list styles to detail panel */
    .detail-panel .section-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin: 10px 0 6px;
      font-weight: 500;
    }

    .detail-panel ul,
    .detail-panel ol {
      margin: 0 0 4px 18px;
      padding: 0;
      color: var(--ink);
      font-size: 0.92rem;
      line-height: 1.5;
    }

    .detail-panel li {
      margin-bottom: 6px;
    }

    .detail-panel .empty {
      color: var(--muted);
      font-size: 0.92rem;
      font-style: italic;
    }

    /* ===== NEWSLETTER SECTION ===== */
    .newsletter-section {
      position: relative;
      background: var(--accent-soft);
      border: 1px solid #c8e0d5;
      border-radius: 16px;
      padding: 16px;
      margin-top: 20px;
      margin-bottom: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .newsletter-section.hidden {
      display: none;
    }

    .newsletter-form {
      width: 100%;
      max-width: 560px;
      display: flex;
      justify-content: center;
    }

    .newsletter-form iframe {
      border-radius: 8px;
      max-width: 100%;
    }

    .newsletter-dismiss {
      position: absolute;
      top: 8px;
      right: 12px;
      background: transparent;
      border: none;
      font-size: 20px;
      color: var(--accent);
      cursor: pointer;
      opacity: 0.5;
      transition: opacity 0.2s;
    }

    .newsletter-dismiss:hover {
      opacity: 1;
    }

    @media (max-width: 600px) {
      .newsletter-section {
        padding: 12px 8px;
      }

      .newsletter-form iframe {
        height: 300px;
      }
    }

    /* ===== DETAIL PANEL ===== */
    .detail-overlay {
      position: fixed;
      inset: 0;
      background: rgba(28, 27, 25, 0.4);
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .detail-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .detail-panel {
      position: fixed;
      background: var(--card);
      z-index: 1000;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      transition: transform 0.3s ease;
    }

    .detail-panel.hidden {
      transform: translateX(100%);
    }

    .detail-panel.visible {
      transform: translateX(0);
    }

    /* Desktop: Side Panel */
    @media (min-width: 769px) {
      .detail-panel {
        top: 0;
        right: 0;
        bottom: 0;
        width: 480px;
        max-width: 50vw;
        height: auto;
        overflow-y: auto;
        border-left: 1px solid var(--line);
        box-shadow: -8px 0 30px rgba(0, 0, 0, 0.12);
        padding: 24px;
        padding-bottom: 100px;
      }

      body.panel-open .page {
        pointer-events: none;
      }
    }

    /* Mobile: Full Screen */
    @media (max-width: 768px) {
      .detail-panel {
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: auto;
        overflow-y: auto;
        padding: 16px;
        padding-top: 70px;
        padding-bottom: 100px;
      }

      body.panel-open {
        overflow: hidden;
        position: fixed;
        width: 100%;
      }
    }

    /* Safe area for notched phones */
    @supports (padding-bottom: env(safe-area-inset-bottom)) {
      .detail-panel {
        padding-bottom: calc(24px + env(safe-area-inset-bottom));
      }
    }

    /* Close button (desktop) */
    .detail-close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: border-color 0.2s, background 0.2s;
    }

    .detail-close-btn:hover {
      border-color: var(--accent);
      background: var(--accent-soft);
    }

    @media (max-width: 768px) {
      .detail-close-btn {
        display: none;
      }
    }

    /* Back button (mobile) */
    .detail-back-btn {
      position: fixed;
      top: 16px;
      left: 16px;
      z-index: 1001;
      display: none;
      align-items: center;
      gap: 6px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 768px) {
      .detail-back-btn {
        display: flex;
      }
    }

    /* Panel content */
    .detail-header {
      margin-bottom: 20px;
      padding-right: 50px;
    }

    .detail-title {
      font-family: "IBM Plex Sans", sans-serif;
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0 0 8px;
      line-height: 1.3;
      color: var(--ink);
    }

    .detail-meta {
      color: var(--muted);
      font-size: 0.95rem;
      margin: 0;
    }

    .detail-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 14px 0;
    }

    .detail-panel .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--accent-soft);
      color: var(--accent);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.82rem;
      font-weight: 500;
    }

    .detail-panel .tag.category {
      background: #e0f2fe;
      color: #075985;
    }

    .detail-panel .tag.job-type {
      background: #e8e4f0;
      color: #5b21b6;
    }

    .detail-panel .tag.deadline {
      background: #fef3e2;
      color: #b45309;
    }

    .detail-salary {
      font-weight: 500;
      color: var(--accent);
      font-size: 1rem;
      margin: 8px 0;
    }

    .detail-section {
      margin: 24px 0;
    }

    .detail-section h4 {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin: 0 0 12px;
      font-weight: 500;
    }

    .detail-section ul {
      margin: 0;
      padding-left: 18px;
    }

    .detail-section li {
      margin-bottom: 10px;
      line-height: 1.55;
      color: var(--ink);
      font-size: 0.92rem;
    }

    .detail-divider {
      height: 1px;
      background: var(--line);
      margin: 20px 0;
    }

    /* Aggregator notice - IMPORTANT for honesty */
    .aggregator-notice {
      background: linear-gradient(135deg, var(--accent-soft) 0%, #f0f7f4 100%);
      border: 1px solid #c8e0d5;
      border-radius: 12px;
      padding: 14px 16px;
      margin: 24px 0;
      font-size: 0.88rem;
      line-height: 1.5;
    }

    .aggregator-notice strong {
      display: block;
      color: var(--accent);
      margin-bottom: 4px;
      font-size: 0.85rem;
    }

    .aggregator-notice p {
      margin: 0;
      color: #2d5a47;
    }

    /* Source label */
    .detail-source {
      font-size: 0.82rem;
      color: var(--muted);
      margin: 16px 0 8px;
    }

    .detail-source span {
      background: var(--accent-soft);
      color: var(--accent);
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 500;
    }

    /* Primary CTA */
    .detail-cta {
      display: block;
      width: 100%;
      background: var(--accent);
      color: white;
      text-align: center;
      padding: 16px 24px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 500;
      text-decoration: none;
      margin-top: 20px;
      transition: background 0.2s;
    }

    .detail-cta:hover {
      background: #174a39;
    }

  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="hero">
        <h1>JobberMed</h1>
        <p>Live medical and healthcare jobs across Nigeria</p>
      </div>
      <div class="stat" id="stat-count">
        <strong>‚Äî</strong>
        <span>Live jobs ¬∑ updated automatically</span>
      </div>
      <div class="stat" id="stat-range">
        <strong>‚Äî</strong>
        <span>Listings period</span>
      </div>
    </header>

    <!-- Newsletter Signup Section -->
    <section class="newsletter-section" id="newsletterSection">
      <div class="newsletter-form">
        <iframe
          width="540"
          height="280"
          src="https://58681e2d.sibforms.com/serve/MUIFAHXVR5tRFBDTcOiuh20_p5-O29yy8k6p5GA7_6vI8Mb29oJKSmjzFdFS_42mJMKpX3gRAnzPHIXoo3rmGHyDPdPUTmBgyYut9bQsy96jN4w0GOoddcGrWFGZYkT0ZFaCl4M5fCzyZig_rPFG-yB2pE-Lqro3GCHZ9det5WfikZkmJgdeG6iMIEktzRDAxSIwlId0D8akd_v1Cw=="
          frameborder="0"
          scrolling="no"
          allowfullscreen
          title="Newsletter signup form"
        ></iframe>
      </div>
      <button class="newsletter-dismiss" id="newsletterDismiss" aria-label="Dismiss newsletter signup">‚úï</button>
    </section>

    <div class="filters" id="filters">
      <!-- Mobile dropdown -->
      <div class="filter-mobile">
        <label class="filter-label" for="categorySelect">Category</label>
        <div class="select-wrap">
          <select id="categorySelect" aria-label="Filter by category"></select>
        </div>
      </div>

      <!-- Desktop chips -->
      <div class="filter-desktop" id="filterChips" aria-label="Category filters"></div>
    </div>

    <div class="filters">
      <div class="filter-location">
        <label class="filter-label" for="locationSelect">Location</label>
        <div class="select-wrap">
          <select id="locationSelect" aria-label="Filter by location"></select>
        </div>
      </div>
    </div>

    <main class="grid" id="grid"></main>
  </div>

  <!-- Detail Overlay (for desktop click-outside-to-close) -->
  <div class="detail-overlay" id="detailOverlay"></div>

  <!-- Detail Panel -->
  <aside class="detail-panel hidden" id="detailPanel" aria-hidden="true" role="dialog" aria-labelledby="detailTitle">
    <button class="detail-close-btn" id="detailCloseBtn" aria-label="Close panel">‚úï</button>
    <button class="detail-back-btn" id="detailBackBtn">‚Üê Back to jobs</button>

    <div class="detail-header">
      <h2 class="detail-title" id="detailTitle"></h2>
      <p class="detail-meta" id="detailMeta"></p>
      <div class="detail-tags" id="detailTags"></div>
      <p class="detail-salary" id="detailSalary"></p>
    </div>

    <div class="detail-divider"></div>

    <div class="detail-section" id="detailReqSection">
      <h4>Requirements</h4>
      <ul id="detailRequirements"></ul>
    </div>

    <div class="detail-section" id="detailRespSection">
      <h4>Responsibilities</h4>
      <ul id="detailResponsibilities"></ul>
    </div>

    <div class="aggregator-notice">
      <strong>üìã About this listing</strong>
      <p>JobberMed aggregates medical jobs from multiple sources. We are not the employer. View the original posting below for application instructions, contact details, and full job information.</p>
    </div>

    <p class="detail-source">Source: <span id="detailSource"></span></p>

    <a class="detail-cta" id="detailCTA" href="" target="_blank" rel="noopener noreferrer">
      View Original Posting ‚Üí
    </a>
  </aside>

  <script>
    const grid = document.getElementById("grid");
    const statCount = document.getElementById("stat-count");
    const statRange = document.getElementById("stat-range");
    const filters = document.getElementById("filters");
    const filterChips = document.getElementById("filterChips");
    const categorySelect = document.getElementById("categorySelect");
    const locationSelect = document.getElementById("locationSelect");
    const CATEGORY_ORDER = [
      "All",
      "Doctors",
      "Nurses & Midwives",
      "Pharmacists",
      "Medical Laboratory Scientists",
      "Dentists",
      "Public Health",
      "Healthcare Management",
      "Allied Health",
      "Others",
    ];
    let activeCategory = "All";
    let activeLocation = "All locations";
    let allJobs = [];

    function safeText(text) {
      return (text || "").toString().trim();
    }

    function getOrdinal(n) {
      const s = ["th", "st", "nd", "rd"];
      const v = n % 100;
      return n + (s[(v - 20) % 10] || s[v] || s[0]);
    }

    function formatDate(dateStr) {
      if (!dateStr) return null;
      const d = new Date(dateStr);
      if (Number.isNaN(d.getTime())) return dateStr;
      
      const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                      "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
      const day = d.getDate();
      const month = months[d.getMonth()];
      const year = d.getFullYear();
      
      return `${day} ${month} ${year}`;
    }

    function isExpired(deadline) {
      if (!deadline) return false;
      const deadlineDate = new Date(deadline);
      if (Number.isNaN(deadlineDate.getTime())) return false;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      return deadlineDate < today;
    }

    function addList(target, items, maxItems = 4) {
      if (!Array.isArray(items) || items.length === 0) {
        const p = document.createElement("p");
        p.className = "empty";
        p.textContent = "Not specified";
        target.appendChild(p);
        return;
      }
      const ul = document.createElement("ul");
      const displayItems = items.slice(0, maxItems);
      displayItems.forEach(item => {
        const text = safeText(item);
        if (text) {
          const li = document.createElement("li");
          li.textContent = text;
          ul.appendChild(li);
        }
      });
      target.appendChild(ul);
      
      if (items.length > maxItems) {
        const more = document.createElement("p");
        more.className = "empty";
        more.textContent = `+ ${items.length - maxItems} more ‚Äî click Apply Now for full details`;
        target.appendChild(more);
      }
    }

    // ===== DETAIL PANEL FUNCTIONALITY =====
    const detailPanel = document.getElementById("detailPanel");
    const detailOverlay = document.getElementById("detailOverlay");
    const detailCloseBtn = document.getElementById("detailCloseBtn");
    const detailBackBtn = document.getElementById("detailBackBtn");
    let currentJob = null;

    // Generate a URL-friendly slug from job
    function getJobSlug(job) {
      if (job.apply_url) {
        const match = job.apply_url.match(/[^/]+$/);
        if (match) return match[0];
      }
      return (job.job_title || "job")
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "")
        .substring(0, 60);
    }

    // Find job by slug
    function findJobBySlug(slug) {
      if (!slug) return null;
      return allJobs.find(j => {
        const jobSlug = getJobSlug(j);
        return jobSlug === slug || (j.apply_url && j.apply_url.includes(slug));
      });
    }

    // Populate list (show ALL items, no truncation)
    function populateDetailList(container, items) {
      container.innerHTML = "";
      if (!Array.isArray(items) || items.length === 0) {
        const li = document.createElement("li");
        li.className = "empty";
        li.textContent = "Not specified";
        container.appendChild(li);
        return;
      }
      items.forEach(item => {
        const text = (item || "").toString().trim();
        if (text) {
          const li = document.createElement("li");
          li.textContent = text;
          container.appendChild(li);
        }
      });
    }

    // Open detail panel
    function openDetail(job) {
      if (!job) return;
      currentJob = job;

      // Update URL without reload
      const slug = getJobSlug(job);
      const url = new URL(window.location);
      url.searchParams.set("job", slug);
      history.pushState({ job: slug }, "", url.toString());

      // Populate header
      document.getElementById("detailTitle").textContent = job.job_title || "Untitled Role";
      document.getElementById("detailMeta").textContent =
        [job.company, job.location].filter(Boolean).join(" ‚Ä¢ ") || "Company not listed";
      document.getElementById("detailSalary").textContent = job.salary || "Salary not listed";

      // Source
      const sourceMap = {
        medlocum: "MedLocum Jobs",
        jobsinnigeria: "Jobs In Nigeria",
        medicalworldnigeria: "Medical World Nigeria",
      };
      document.getElementById("detailSource").textContent =
        sourceMap[job._source] || job._source || "External Source";

      // Tags
      const tagsContainer = document.getElementById("detailTags");
      tagsContainer.innerHTML = "";

      if (job.date_posted) {
        const tag = document.createElement("div");
        tag.className = "tag";
        tag.textContent = `Posted ${formatDate(job.date_posted)}`;
        tagsContainer.appendChild(tag);
      }

      const category = normalizeCategory(job);
      if (category && category !== "Others") {
        const tag = document.createElement("div");
        tag.className = "tag category";
        tag.textContent = category;
        tagsContainer.appendChild(tag);
      }

      if (job.job_type) {
        const tag = document.createElement("div");
        tag.className = "tag job-type";
        tag.textContent = job.job_type;
        tagsContainer.appendChild(tag);
      }

      if (job.deadline) {
        const tag = document.createElement("div");
        tag.className = "tag deadline";
        tag.textContent = `Closes ${formatDate(job.deadline)}`;
        tagsContainer.appendChild(tag);
      }

      // Content sections - show ALL items
      populateDetailList(document.getElementById("detailRequirements"), job.requirements);
      populateDetailList(document.getElementById("detailResponsibilities"), job.responsibilities);

      // Hide responsibilities section if empty
      const respSection = document.getElementById("detailRespSection");
      respSection.style.display = (job.responsibilities && job.responsibilities.length > 0) ? "block" : "none";

      // CTA button
      const cta = document.getElementById("detailCTA");
      if (job.apply_url) {
        cta.href = job.apply_url;
        cta.textContent = "View Original Posting ‚Üí";
        cta.classList.remove("disabled");
      } else {
        cta.href = "#";
        cta.textContent = "No application link available";
        cta.classList.add("disabled");
      }

      // Show panel
      detailPanel.classList.remove("hidden");
      detailPanel.classList.add("visible");
      detailPanel.setAttribute("aria-hidden", "false");
      detailOverlay.classList.add("visible");
      document.body.classList.add("panel-open");

      // Scroll panel to top
      detailPanel.scrollTop = 0;
    }

    // Close detail panel
    function closeDetail() {
      currentJob = null;

      // Update URL - remove job param
      const url = new URL(window.location);
      url.searchParams.delete("job");
      const newUrl = url.searchParams.toString() ? `${url.pathname}?${url.searchParams}` : url.pathname;
      history.pushState({}, "", newUrl);

      // Hide panel
      detailPanel.classList.add("hidden");
      detailPanel.classList.remove("visible");
      detailPanel.setAttribute("aria-hidden", "true");
      detailOverlay.classList.remove("visible");
      document.body.classList.remove("panel-open");
    }

    // Check URL for job param on load
    function checkUrlForJob() {
      const params = new URLSearchParams(window.location.search);
      const jobSlug = params.get("job");
      if (jobSlug) {
        const job = findJobBySlug(jobSlug);
        if (job) {
          openDetail(job);
        }
      }
    }

    // Event listeners for closing
    detailCloseBtn.addEventListener("click", closeDetail);
    detailBackBtn.addEventListener("click", closeDetail);
    detailOverlay.addEventListener("click", closeDetail);

    // Keyboard: Escape to close
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && currentJob) {
        closeDetail();
      }
    });

    // Browser back/forward navigation
    window.addEventListener("popstate", () => {
      const params = new URLSearchParams(window.location.search);
      const jobSlug = params.get("job");
      if (jobSlug) {
        const job = findJobBySlug(jobSlug);
        if (job) {
          openDetail(job);
        } else {
          closeDetail();
        }
      } else {
        closeDetail();
      }
    });

    // ===== NEWSLETTER DISMISS FUNCTIONALITY =====
    const newsletterSection = document.getElementById("newsletterSection");
    const newsletterDismiss = document.getElementById("newsletterDismiss");
    const NEWSLETTER_STORAGE_KEY = "jobbermed_newsletter_dismissed";
    const DISMISS_DURATION_DAYS = 14;

    function isNewsletterDismissed() {
      const dismissed = localStorage.getItem(NEWSLETTER_STORAGE_KEY);
      if (!dismissed) return false;

      const dismissedDate = new Date(parseInt(dismissed, 10));
      const now = new Date();
      const daysSinceDismissed = (now - dismissedDate) / (1000 * 60 * 60 * 24);

      return daysSinceDismissed < DISMISS_DURATION_DAYS;
    }

    function dismissNewsletter() {
      localStorage.setItem(NEWSLETTER_STORAGE_KEY, Date.now().toString());
      newsletterSection.classList.add("hidden");
    }

    function initNewsletter() {
      if (!newsletterSection || !newsletterDismiss) return;

      if (isNewsletterDismissed()) {
        newsletterSection.classList.add("hidden");
      }

      newsletterDismiss.addEventListener("click", dismissNewsletter);
    }

    initNewsletter();

    function getCategoryFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const cat = safeText(params.get("category"));
      return cat || "All";
    }

    function setCategoryInUrl(category) {
      const url = new URL(window.location.href);
      if (!category || category === "All") {
        url.searchParams.delete("category");
      } else {
        url.searchParams.set("category", category);
      }
      window.history.replaceState({}, "", url.toString());
    }

    function normalizeCategory(job) {
      const title = (typeof job === "object"
        ? safeText(job.job_title)
        : safeText(job)
      ).toLowerCase();

      if (!title) return "Others";

      if (title.includes("medical laboratory") || (title.includes("laboratory") && title.includes("scientist"))) {
        return "Medical Laboratory Scientists";
      }
      if (title.includes("dentist") || title.includes("dental")) return "Dentists";
      if (title.includes("pharmacist") || title.includes("pharmacy")) return "Pharmacists";
      if (title.includes("nurse") || title.includes("nursing") || title.includes("midwife") || title.includes("midwifery") || title.includes("matron")) {
        return "Nurses & Midwives";
      }
      if (title.includes("doctor") || title.includes("physician") || title.includes("medical officer") ||
          title.includes("obstetrician") || title.includes("gynaecologist") || title.includes("oncology") ||
          title.includes("general practitioner")) {
        return "Doctors";
      }
      if (title.includes("public health") || title.includes("program officer") || title.includes("programme officer") ||
          title.includes("epidemiology") || title.includes("surveillance") || title.includes("health systems") ||
          title.includes("health security") || title.includes("project officer")) {
        return "Public Health";
      }
      if (title.includes("director") || title.includes("manager") || title.includes("coordinator") ||
          title.includes("management") || title.includes("provost") || title.includes("hse") ||
          title.includes("inventory") || title.includes("warehouse") || title.includes("quality officer")) {
        return "Healthcare Management";
      }
      if (title.includes("physiotherapist") || title.includes("optometrist") || title.includes("therapist") ||
          title.includes("radiographer") || title.includes("dietitian") || title.includes("nutritionist")) {
        return "Allied Health";
      }
      return "Others";
    }

    const NIGERIAN_STATES = [
      "Abia", "Adamawa", "Akwa Ibom", "Anambra", "Bauchi", "Bayelsa", "Benue",
      "Borno", "Cross River", "Delta", "Ebonyi", "Edo", "Ekiti", "Enugu",
      "Gombe", "Imo", "Jigawa", "Kaduna", "Kano", "Katsina", "Kebbi", "Kogi",
      "Kwara", "Lagos", "Nasarawa", "Niger", "Ogun", "Ondo", "Osun", "Oyo",
      "Plateau", "Rivers", "Sokoto", "Taraba", "Yobe", "Zamfara"
    ];

    const CITY_TO_STATE = {
      "abuja": "FCT",
      "fct": "FCT",
      "lagos": "Lagos",
      "kano": "Kano",
      "ibadan": "Oyo",
      "port harcourt": "Rivers",
      "benin": "Edo",
      "benin city": "Edo",
      "kaduna": "Kaduna",
      "enugu": "Enugu",
      "jos": "Plateau",
      "ilorin": "Kwara",
      "sokoto": "Sokoto",
      "calabar": "Cross River",
      "warri": "Delta",
      "owerri": "Imo",
      "uyo": "Akwa Ibom",
      "abeokuta": "Ogun",
      "maiduguri": "Borno",
      "zaria": "Kaduna",
      "aba": "Abia",
      "ogbomoso": "Oyo",
      "onitsha": "Anambra",
      "akure": "Ondo",
      "bauchi": "Bauchi",
      "yola": "Adamawa",
      "gombe": "Gombe",
      "lafia": "Nasarawa",
      "lokoja": "Kogi",
      "minna": "Niger",
      "oshogbo": "Osun",
      "asaba": "Delta",
      "awka": "Anambra",
      "birnin kebbi": "Kebbi",
      "damaturu": "Yobe",
      "dutse": "Jigawa",
      "ado ekiti": "Ekiti",
      "gusau": "Zamfara",
      "jalingo": "Taraba",
      "katsina": "Katsina",
      "umuahia": "Abia",
      "yenagoa": "Bayelsa",
      "mowe": "Ogun",
      "keffi": "Nasarawa"
    };

    const COUNTRY_ALIASES = [
      ["uk", "UK"],
      ["united kingdom", "UK"],
      ["zambia", "Zambia"],
      ["ghana", "Ghana"],
      ["kenya", "Kenya"],
      ["uganda", "Uganda"],
      ["tanzania", "Tanzania"],
      ["rwanda", "Rwanda"],
      ["south africa", "South Africa"],
      ["united states", "United States"],
      ["usa", "United States"],
      ["canada", "Canada"],
      ["germany", "Germany"],
      ["france", "France"],
      ["netherlands", "Netherlands"],
      ["switzerland", "Switzerland"],
      ["sweden", "Sweden"],
      ["norway", "Norway"],
      ["denmark", "Denmark"],
      ["australia", "Australia"],
    ];

    function getLocationBuckets(location) {
      const raw = safeText(location);
      if (!raw) return [];
      const lower = raw.toLowerCase();
      const hasWord = (word) => new RegExp(`\\b${word}\\b`, "i").test(raw);
      const buckets = new Set();
      const isNigeria = hasWord("nigeria") || NIGERIAN_STATES.some(s => hasWord(s.toLowerCase()));

      if (isNigeria) {
        NIGERIAN_STATES.forEach(state => {
          if (hasWord(state.toLowerCase())) {
            buckets.add(`${state} State`);
          }
        });

        Object.keys(CITY_TO_STATE).forEach(city => {
          if (hasWord(city)) {
            const state = CITY_TO_STATE[city];
            if (state === "FCT") {
              buckets.add("FCT");
            } else {
              buckets.add(`${state} State`);
            }
          }
        });

        if (buckets.size === 0) {
          return [];
        }
        return Array.from(buckets);
      }

      for (const [needle, label] of COUNTRY_ALIASES) {
        if (lower.includes(needle)) return [label];
      }

      const parts = raw.split(",").map(p => p.trim()).filter(Boolean);
      if (parts.length > 1) {
        return [parts[parts.length - 1]];
      }
      return [raw];
    }

    function updateStats(list) {
      statCount.querySelector("strong").textContent = String(list.length);
      const dates = list.map(j => j.date_posted).filter(Boolean).sort();
      if (dates.length) {
        const oldest = formatDate(dates[0]);
        const newest = formatDate(dates[dates.length - 1]);
        statRange.querySelector("strong").textContent = `${oldest} to ${newest}`;
      } else {
        statRange.querySelector("strong").textContent = "Unknown";
      }
    }

    function renderFilters() {
      const activeJobs = allJobs.filter(j => !isExpired(j.deadline));
      const counts = {};
      CATEGORY_ORDER.forEach(c => { counts[c] = 0; });
      activeJobs.forEach(j => {
        const cat = normalizeCategory(j);
        counts[cat] = (counts[cat] || 0) + 1;
        counts.All += 1;
      });

      const validSet = new Set(CATEGORY_ORDER);
      if (!validSet.has(activeCategory)) activeCategory = "All";

      // Desktop chips
      filterChips.innerHTML = "";
      CATEGORY_ORDER.forEach(cat => {
        const btn = document.createElement("button");
        const count = cat === "All" ? activeJobs.length : (counts[cat] || 0);
        btn.className = `filter-btn${cat === activeCategory ? " active" : ""}`;
        btn.type = "button";
        btn.textContent = `${cat} (${count})`;
        btn.setAttribute("aria-pressed", cat === activeCategory ? "true" : "false");
        btn.addEventListener("click", () => {
          activeCategory = cat;
          setCategoryInUrl(activeCategory);
          renderJobs();
          renderFilters();
        });
        filterChips.appendChild(btn);
      });

      // Mobile dropdown
      categorySelect.innerHTML = "";
      CATEGORY_ORDER.forEach(cat => {
        const opt = document.createElement("option");
        const count = cat === "All" ? activeJobs.length : (counts[cat] || 0);
        opt.value = cat;
        opt.textContent = `${cat} (${count})`;
        categorySelect.appendChild(opt);
      });
      categorySelect.value = activeCategory;

      if (!categorySelect.dataset.bound) {
        categorySelect.addEventListener("change", () => {
          activeCategory = categorySelect.value || "All";
          setCategoryInUrl(activeCategory);
          renderJobs();
          renderFilters();
        });
        categorySelect.dataset.bound = "1";
      }

      // Location dropdown
      const locationCounts = {};
      activeJobs.forEach(j => {
        const buckets = j._locationBuckets || [];
        buckets.forEach(b => {
          locationCounts[b] = (locationCounts[b] || 0) + 1;
        });
      });
      const locationOptions = ["All locations", ...Object.keys(locationCounts).sort()];

      if (!locationOptions.includes(activeLocation)) {
        activeLocation = "All locations";
      }

      locationSelect.innerHTML = "";
      locationOptions.forEach(loc => {
        const opt = document.createElement("option");
        opt.value = loc;
        opt.textContent = loc === "All locations" ? "All locations" : `${loc} (${locationCounts[loc] || 0})`;
        locationSelect.appendChild(opt);
      });
      locationSelect.value = activeLocation;

      if (!locationSelect.dataset.bound) {
        locationSelect.addEventListener("change", () => {
          activeLocation = locationSelect.value || "All locations";
          renderJobs();
          renderFilters();
        });
        locationSelect.dataset.bound = "1";
      }
    }

    function renderJobs() {
      let list = activeCategory === "All"
        ? allJobs
        : allJobs.filter(j => normalizeCategory(j) === activeCategory);
      list = activeLocation === "All locations"
        ? list
        : list.filter(j => (j._locationBuckets || []).includes(activeLocation));
      list = list.filter(j => !isExpired(j.deadline));
      grid.innerHTML = "";
      updateStats(list);

      list.forEach(j => {
        const card = document.createElement("article");
        card.className = "card clickable";

        // Make card clickable to open detail panel
        card.addEventListener("click", (e) => {
          if (e.target.closest(".apply-btn")) return;
          openDetail(j);
        });

        // Title
        const title = document.createElement("h3");
        title.className = "title";
        title.textContent = safeText(j.job_title) || "Untitled role";

        // Meta: Company ‚Ä¢ Location
        const meta = document.createElement("div");
        meta.className = "meta";
        const company = safeText(j.company);
        const location = safeText(j.location);
        meta.textContent = [company, location].filter(Boolean).join(" ‚Ä¢ ") || "Company not listed";

        // Tags (minimal: job type + deadline only)
        const tags = document.createElement("div");
        tags.className = "tags";

        if (j.job_type && safeText(j.job_type)) {
          const typeTag = document.createElement("div");
          typeTag.className = "tag job-type";
          typeTag.textContent = safeText(j.job_type);
          tags.appendChild(typeTag);
        }

        if (j.deadline && safeText(j.deadline)) {
          const deadlineTag = document.createElement("div");
          deadlineTag.className = "tag deadline";
          deadlineTag.textContent = `Closes ${formatDate(j.deadline)}`;
          tags.appendChild(deadlineTag);
        }

        // Salary
        const salary = document.createElement("div");
        salary.className = "salary";
        salary.textContent = safeText(j.salary) || "Salary not listed";

        // Action buttons row
        const actions = document.createElement("div");
        actions.className = "card-actions";

        // View Details button
        const viewBtn = document.createElement("button");
        viewBtn.className = "view-btn";
        viewBtn.textContent = "View Details";
        viewBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          openDetail(j);
        });

        // Apply Now button
        const applyUrl = safeText(j.apply_url);
        const applyBtn = document.createElement("a");
        applyBtn.className = "apply-btn";
        if (applyUrl) {
          applyBtn.href = applyUrl;
          applyBtn.target = "_blank";
          applyBtn.rel = "noopener noreferrer";
          applyBtn.textContent = "Apply Now ‚Üí";
        } else {
          applyBtn.className = "apply-btn disabled";
          applyBtn.textContent = "No link";
        }

        actions.appendChild(viewBtn);
        actions.appendChild(applyBtn);

        // Build card (minimal structure)
        card.appendChild(title);
        card.appendChild(meta);
        card.appendChild(tags);
        card.appendChild(salary);
        card.appendChild(actions);

        grid.appendChild(card);
      });
    }

    fetch("master_jobs.json")
      .then(r => r.json())
      .then(data => {
        // Handle both flat array and {jobs: [...]} wrapper formats
        const jobs = Array.isArray(data) ? data : (data.jobs || []);
        
        if (jobs.length === 0) {
          throw new Error("No jobs found");
        }

        jobs.sort((a, b) => (b.date_posted || "").localeCompare(a.date_posted || ""));
        allJobs = jobs.map(j => {
          return { ...j, _locationBuckets: getLocationBuckets(j.location) };
        });
        activeCategory = getCategoryFromUrl();
        renderFilters();
        renderJobs();
        checkUrlForJob();
      })
      .catch(err => {
        grid.innerHTML = `<p style="color: var(--muted); padding: 40px; text-align: center;">
          Could not load jobs data. Please try again later.
        </p>`;
        console.error(err);
      });
  </script>
</body>
</html>
